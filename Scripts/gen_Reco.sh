#!/usr/bin/bash

usage() { echo "Usage: $0
  [ --primary primary physics name ]
  [ --campaign campaign name ]
  [ --dver digi campaign version ]
  [ --rver reco campaign version ]
  [ --dbpurpose purpose of db e.g. perfect, startup, best  ]
  [ --dbversion db version ]
  [ --digitype OnSpill, OffSpill, Mix1BB, Mix2BB, etc. ]
  [ --stream Triggered, Triggerable ]
  [ --merge merge factor (opt) default 10]
  [ --recodbversion (opt) db version to use for reco]
  [ --makeSS (opt) default \"true\". override with null to not create Surface Steps
  [ --owner (opt) default mu2e ]
  [ --samopt (opt) Options to samListLocation default "-f --schema=root" ]
  [ --cat (opt) If non-null, optionally add 'Cat' to the input digi collection name
  [ --digis (opt)  If specified, use this list of input dig.*.art files instead of the one generated by SAM ]
  e.g.  bash gen_Reco.sh --primary CeEndpoint --campaign MDC2020 --dver v --rver v  --dbpurpose best --dbversion v1_1 --merge 10 --digitype OnSpill --stream Triggered
"
}

# Function: Exit with error.
exit_abnormal() {
  usage
  exit 1
}

PRIMARY="" # name of primary
CAMPAIGN="" # e.g. MDC2020
DIGI_VERSION="" # digi (input) campaign version
RECO_VERSION="" # reco (output) campaign resion
DB_PURPOSE="" # db purpose
DIGIDB_VERSION="" # db version
RECODB_VERSION="" # db version
DIGITYPE="" # digitype
MERGE=1 # merge factor
OWNER=mu2e
STREAM=Triggered
SAMOPT="-f --schema=root"
DIGIS=""
CAT=""
MAKESS="true"

# Loop: Get the next option;
while getopts ":-:" options; do
  case "${options}" in
    -)
      case "${OPTARG}" in
        primary)
          PRIMARY=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        campaign)
          CAMPAIGN=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        dver)
          DIGI_VERSION=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        rver)
          RECO_VERSION=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        dbpurpose)
          DB_PURPOSE=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        dbversion)
          DIGIDB_VERSION=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        recodbversion)
          RECODB_VERSION=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        digitype)
          DIGITYPE=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        merge)
          MERGE=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        owner)
          OWNER=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        stream)
          STREAM=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        digis)
          DIGIS=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        cat)
          CAT=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        samopt)
          SAMOPT=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        makeSS)
          MAKESS=${!OPTIND} OPTIND=$(( $OPTIND + 1 ))
          ;;
        *)
          echo "Unnown option " ${OPTARG}
          exit_abnormal
          ;;
        esac;;
    :)                                    # If expected argument omitted:
      echo "Error: -${OPTARG} requires an argument."
      exit_abnormal                       # Exit abnormally.
      ;;
    *)                                    # If unknown (any other) option:
      exit_abnormal                       # Exit abnormally.
      ;;
    esac
done

if [ -z "$PRIMARY" ] || [ -z "$CAMPAIGN" ] || [ -z "$DIGI_VERSION" ] || [ -z "$RECO_VERSION" ] || [ -z "$DB_PURPOSE" ] || [ -z "$DIGITYPE" ] || [ -z "$DIGIDB_VERSION" ]; then
  echo " Missing Arguments"
  exit_abnormal
fi
if [ -z ${RECODB_VERSION} ] && ! [ -z ${DIGIDB_VERSION} ]; then
  RECODB_VERSION=$DIGIDB_VERSION
fi

# Test: run a test to check the SimJob for this campaign verion exists
DIR=/cvmfs/mu2e.opensciencegrid.org/Musings/SimJob/${CAMPAIGN}${RECO_VERSION}
if [ -d "$DIR" ];
  then
    echo "Musing $DIR exists."
  else
    echo "Musing $DIR does not exist."
    exit_abnormal
fi

echo "Generating reco scripts for ${PRIMARY} digi type ${DIGITYPE} digi version ${DIGI_VERSION} output version ${RECO_VERSION} database purpose, version (digi, reco) ${DB_PURPOSE} ${DIGIDB_VERSION} ${RECODB_VERSION}"

rm Digis.txt
if [[ -n $DIGIS ]];
then
  echo "Using user-provided input list of digs $DIGIS"
  ln -s $DIGIS Digis.txt
elif [[ "${DIGITYPE}" == "Extracted" || "${DIGITYPE}" == "NoField" ]]; then
    samweb list-definition-files "dig.${OWNER}.${PRIMARY}${CAT}${STREAM}.${CAMPAIGN}${DIGI_VERSION}_${DB_PURPOSE}_${DIGIDB_VERSION}.art" > Digis.txt
else
    samweb list-definition-files "dig.${OWNER}.${PRIMARY}${DIGITYPE}${CAT}${STREAM}.${CAMPAIGN}${DIGI_VERSION}_${DB_PURPOSE}_${DIGIDB_VERSION}.art" > Digis.txt
fi

if [[ "${DIGITYPE}" == "Extracted" || "${DIGITYPE}" == "NoField" ]]; then
  echo "#include \"Production/JobConfig/reco/${DIGITYPE}.fcl\"" > reco.fcl
else
  echo '#include "Production/JobConfig/reco/Reco.fcl"' > reco.fcl
fi

if [[ -n $SETUP ]]; then
  echo "Using user-provided setup $SETUP"
else
  SETUP=${DIR}/setup.sh
fi

echo 'services.DbService.purpose:' ${CAMPAIGN}'_'${DB_PURPOSE} >> reco.fcl
echo 'services.DbService.version:' ${RECODB_VERSION} >> reco.fcl
echo 'services.DbService.verbose : 2' >> reco.fcl
if [[ -n $MAKESS ]];
then
  echo "#include \"Production/JobConfig/reco/MakeSurfaceSteps.fcl\"">> reco.fcl
fi

DSCONF=${CAMPAIGN}${RECO_VERSION}_${DB_PURPOSE}_${RECODB_VERSION}

cmd="mu2ejobdef --embed reco.fcl --override-output-description --auto-description --setup ${SETUP} --auto-description --dsconf ${DSCONF} --inputs Digis.txt --merge-factor=${MERGE}"
echo "Running: $cmd"
$cmd

parfile=$(ls cnf.*.tar)
# Remove cnf.
index_dataset=${parfile:4}
# Remove .0.tar
index_dataset=${index_dataset::-6}

idx=$(mu2ejobquery --njobs cnf.*.tar)
idx_format=$(printf "%07d" $idx)
echo $idx
echo "Creating index definiton with size: $idx"
samweb create-definition idx_${index_dataset} "dh.dataset etc.mu2e.index.000.txt and dh.sequencer < ${idx_format}"
echo "Created definiton: idx_${index_dataset}"
samweb describe-definition idx_${index_dataset}
